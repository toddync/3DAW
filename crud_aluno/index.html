<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CRUD Alunos</title>
    <style>
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: inline-block; width: 100px; }
        input { padding: 8px; width: 300px; }
        button { padding: 8px 15px; margin: 5px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .message { 
            margin: 20px 0; 
            padding: 10px; 
            border-radius: 4px; 
            display: none;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .actions { display: flex; gap: 5px; }
        .loading { opacity: 0.6; pointer-events: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Gerenciamento de Alunos</h1>

        <!-- Create/Edit Form -->
        <h2 id="form-title">Adicionar Novo Aluno</h2>
        <form id="aluno-form">
            <input type="hidden" name="id" id="id">
            
            <div class="form-group">
                <label for="matricula">Matrícula:</label>
                <input type="text" name="matricula" id="matricula" required maxlength="50">
            </div>
            
            <div class="form-group">
                <label for="cpf">CPF:</label>
                <input type="text" name="cpf" id="cpf" required minlength="11" maxlength="11">
            </div>
            
            <div class="form-group">
                <label for="nome">Nome:</label>
                <input type="text" name="nome" id="nome" required maxlength="50">
            </div>
            
            <button type="submit" id="save-btn">Salvar</button>
            <button type="button" onclick="resetForm()">Cancelar</button>
        </form>

        <!-- Message display -->
        <div id="message" class="message"></div>

        <!-- List Alunos -->
        <h2>Lista de Alunos</h2>
        <div id="alunos-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Matrícula</th>
                        <th>CPF</th>
                        <th>Nome</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="alunos-table-body">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // API endpoint - adjust if your PHP file has a different name
        const API_BASE = window.location.href + "CRUD.php";
        
        // DOM elements
        const form = document.getElementById('aluno-form');
        const messageDiv = document.getElementById('message');
        const tableBody = document.getElementById('alunos-table-body');
        const saveBtn = document.getElementById('save-btn');

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            loadAlunos();
            
            // Form submission handler
            form.addEventListener('submit', handleFormSubmit);
        });

        // Load all alunos
        async function loadAlunos() {
            try {
                const response = await fetch(API_BASE + '?action=read');
                if (!response.ok) throw new Error('Network response was not ok');
                
                const alunos = await response.json();
                renderAlunosTable(alunos);
            } catch (error) {
                showMessage('Erro ao carregar alunos: ' + error.message, 'error');
            }
        }

        // Render alunos table
        function renderAlunosTable(alunos) {
            tableBody.innerHTML = '';
            
            if (!alunos || alunos.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5">Nenhum aluno cadastrado</td></tr>';
                return;
            }
            
            alunos.forEach(aluno => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${aluno.id}</td>
                    <td>${aluno.matricula}</td>
                    <td>${aluno.cpf}</td>
                    <td>${aluno.nome}</td>
                    <td class="actions">
                        <button onclick="editAluno(${aluno.id})">Editar</button>
                        <button onclick="deleteAluno(${aluno.id})">Excluir</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Handle form submission
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(form);
            const id = document.getElementById('id').value;
            const action = id ? 'update' : 'create';
            
            // Add action to form data
            formData.append('action', action);
            
            try {
                // Show loading state
                setFormLoading(true);
                
                const response = await fetch(API_BASE, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error('Network response was not ok');
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    resetForm();
                    loadAlunos();
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('Erro: ' + error.message, 'error');
            } finally {
                setFormLoading(false);
            }
        }

        // Edit aluno
        async function editAluno(id) {
            try {
                const response = await fetch(API_BASE + `?action=readOne&id=${id}`);
                if (!response.ok) throw new Error('Network response was not ok');
                
                const aluno = await response.json();
                
                if (aluno) {
                    document.getElementById('form-title').textContent = 'Editar Aluno';
                    document.getElementById('id').value = aluno.id;
                    document.getElementById('matricula').value = aluno.matricula;
                    document.getElementById('cpf').value = aluno.cpf;
                    document.getElementById('nome').value = aluno.nome;
                    
                    // Scroll to form
                    document.getElementById('aluno-form').scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                showMessage('Erro ao carregar dados do aluno: ' + error.message, 'error');
            }
        }

        // Delete aluno
        async function deleteAluno(id) {
            if (!confirm('Tem certeza que deseja excluir este aluno?')) {
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('action', 'delete');
                formData.append('id', id);
                
                const response = await fetch(API_BASE, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error('Network response was not ok');
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    loadAlunos();
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('Erro: ' + error.message, 'error');
            }
        }

        // Reset form
        function resetForm() {
            document.getElementById('form-title').textContent = 'Adicionar Novo Aluno';
            form.reset();
            document.getElementById('id').value = '';
        }

        // Show message
        function showMessage(message, type) {
            messageDiv.textContent = message;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Set form loading state
        function setFormLoading(loading) {
            if (loading) {
                saveBtn.disabled = true;
                saveBtn.textContent = 'Salvando...';
                form.classList.add('loading');
            } else {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Salvar';
                form.classList.remove('loading');
            }
        }
    </script>
</body>
</html>